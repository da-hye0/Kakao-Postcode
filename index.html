<!DOCTYPE html>

<html lang="ko">
<head>
  <title>주소 찾기</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
  <script src="https://spi.maps.daum.net/imap/map_js_init/postcode.v2.js"></script>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5bcdc35b4e66ca289e7049a39fe44e41&libraries=services"></script>
</head>
<body onload="execDaumPostcode()">
<div id="layer" style="display:block; position:absolute; overflow:hidden; z-index:1; -webkit-overflow-scrolling:touch;"></div>
<script>
  window.addEventListener("message", onReceivedPostMessage, false);

  function onReceivedPostMessage(event) {
    var action = event.data.action;
    var params = event.data.params;
    console.log("onReceivedPostMessage " + event);
  }

  function onReceivedActivityMessageViaJavascriptInterface(json) {
    var data = JSON.parse(json);
    var action = data.action;
    var params = data.params;
    console.log("onReceivedActivityMessageViaJavascriptInterface " + event);
  }

  function postMessageToiOS(postData) {
    window.webkit.messageHandlers.callBackHandler.postMessage(postData);
  }

  var element_layer = document.getElementById('layer');

  function execDaumPostcode() {
    new daum.Postcode({
      oncomplete: function(data) {
        var jibunAddress = data.autoJibunAddress || data.jibunAddress || "";
        var apartment = data.apartment || "";
        var buildingName = data.buildingName || "";

        // 주소 정보 객체
        var postData = {
          roadAddress: data.roadAddress,
          jibunAddress: jibunAddress,
          zonecode: data.zonecode,
          apartment: apartment,
          buildingName: buildingName
        };

        // 위도, 경도 요청
        getCoordinates(data.roadAddress || jibunAddress, function(coords) {
          if (coords) {
            postData.latitude = coords.lat;
            postData.longitude = coords.lng;

            // iOS로 전달
            window.postMessageToiOS(postData);
          } else {
            console.error("위도와 경도를 가져오는 데 실패했습니다.");
          }
        });
      },
      width: '100%',
      height: '100%'
    }).embed(element_layer);
    element_layer.style.display = 'block';
    initLayerPosition();
  }

  function initLayerPosition() {
    var width = (window.innerWidth || document.documentElement.clientWidth);
    var height = (window.innerHeight || document.documentElement.clientHeight);
    element_layer.style.width = width + 'px';
    element_layer.style.height = height + 'px';
    element_layer.style.left = (((window.innerWidth || document.documentElement.clientWidth) - width) / 2) + 'px';
    element_layer.style.top = (((window.innerHeight || document.documentElement.clientHeight) - height) / 2) + 'px';
  }

  // Kakao Map API를 사용하여 위도와 경도 얻기
  function getCoordinates(address, callback) {
    var geocoder = new kakao.maps.services.Geocoder();

    geocoder.addressSearch(address, function(result, status) {
      if (status === kakao.maps.services.Status.OK) {
        var coords = {
          lat: result[0].y,
          lng: result[0].x
        };
        callback(coords);
      } else {
        callback(null);
      }
    });
  }
</script>
</body>
</html>
